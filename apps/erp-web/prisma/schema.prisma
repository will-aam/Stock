// Esquema do banco de dados para o sistema Val
// Sistema de Gestão de Lotes e Validades para Varejo
// Versão Refatorada e Refinada: Produto Global + Contexto de Loja

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // ou "mysql", "sqlite", etc.
  url      = env("DATABASE_URL")
}

// Enums Refinados e Adicionais
enum UserRole {
  ADMIN
  MANAGER
  STOCKER
}

enum BatchStatus {
  SAFE      // Vence em > 45 dias
  WARNING   // Vence em 15-45 dias
  CRITICAL  // Vence em < 15 dias
  EXPIRED   // Já vencido
  DEPLETED  // Estoque zerado
}

enum AuditActionType {
  ENTRY         // Nova entrada de lote
  CONFIRMED     // Presença confirmada em auditoria
  DEPLETED      // Marcado como vazio
  SOLD          // Registrar venda manual
  ADJUSTED      // Ajuste de estoque
  EXPIRED       // Marcado como vencido
}

// Enums de Regras Fiscais (para maior segurança e consistência)
enum TaxRegime {
  SIMPLES_NACIONAL
  LUCRO_PRESUMIDO
  LUCRO_REAL
}

enum FiscalType {
  REVENDA_MERCADORIA
  MATERIA_PRIMA
  EMBALAGEM
  USO_CONSUMO
  ATIVO_FIXO
  BRINDE
}

enum Origin {
  NACIONAL_0                 // 0 - Nacional, exceto as indicadas nos códigos 3, 4, 5 e 8
  ESTRANGEIRA_IMPORTACAO_1   // 1 - Estrangeira - Importação direta
  ESTRANGEIRA_ADQUIRIDA_2    // 2 - Estrangeira - Adquirida no mercado interno
  NACIONAL Conteudo_3        // 3 - Nacional, conteudo superior 40%
  NACIONAL Processos_4       // 4 - Nacional, processos produtivos básicos
  NACIONAL Conteudo_5        // 5 - Nacional, conteudo inferior 40%
  ESTRANGEira_6              // 6 - Estrangeira - Importação direta, com similar nacional
  ESTRANGEira_7              // 7 - Estrangeira - Adquirida no mercado, com similar nacional
  NACIONAL_MARCA_8           // 8 - Nacional, mercadoria ou bem com Conteúdo de Importação superior a 70%
}

enum PisCofinsRegime {
  CUMULATIVO
  NAO_CUMULATIVO
}

// Modelo de Usuário (Sem alterações relevantes)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String   // Hash da senha
  role      UserRole @default(STOCKER)
  storeId   String?
  store     Store?   @relation(fields: [storeId], references: [id])
  auditLogs AuditLog[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([email])
}

// 1. A Loja agora precisa de seus próprios dados fiscais
model Store {
  id              String     @id @default(cuid())
  name            String
  cnpj            String     @unique // Essencial para o match do XML
  uf              String     // Essencial para cálculo de impostos (ST, Difal)
  taxRegime       TaxRegime  // Regime tributário da loja
  address         String?
  users           User[]
  
  // Relacionamentos
  batches         Batch[]
  purchaseHistory PurchaseHistory[]
  productConfigs  ProductStoreConfig[] // A camada de "Ajuste"
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

// 2. O Produto é o "Mestre Global". Guarda o que não muda (NCM, Nome, EAN).
model Product {
  id                String   @id @default(cuid())
  
  // Dados Básicos (Intrínsecos ao produto)
  ean               String   @unique // Código de barras principal
  name              String
  description       String?
  imageUrl          String?
  category          String   // Corresponde ao 'grupo'
  brand             String?  // Marca
  
  // Unidades e Conversão (Características físicas)
  commercialUnit    String   @default("UN") // Ex: CX, UN, KG
  taxUnit           String   @default("UN") // Unidade tributável padrão (agora obrigatório)
  conversionFactor  Decimal  @default(1.0) @db.Decimal(10, 4)
  
  // Dados Fiscais Gerais (Intrínsecos ao produto)
  fiscalType        FiscalType
  ncm               String
  cest              String?
  origin            Origin   @default(NACIONAL_0)

  // Relacionamentos
  batches           Batch[]            // O lote sabe de qual loja é
  purchaseHistory   PurchaseHistory[]  // O histórico sabe de qual loja é
  storeConfigs      ProductStoreConfig[] // Configurações específicas por loja
  additionalBarcodes Barcode[]        // Múltiplos EANs
  suppliers         ProductSupplier[] // Fornecedores vinculados

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([ean])
  @@index([category])
}

// 3. A Camada de Ajuste (Produto x Empresa)
model ProductStoreConfig {
  id          String   @id @default(cuid())
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Overrides Fiscais (Sobrescrevem o padrão se preenchidos)
  icmsCstIn        String? // Ex: Na filial PR é 000, na filial SP é 060
  icmsCstOut       String?
  icmsRate         Decimal? @db.Decimal(5, 2)
  icmsBcMod        String?
  icmsBcRed        Decimal? @db.Decimal(5, 2)
  icmsSt           Boolean  @default(false)
  icmsMvaOrig      Decimal? @db.Decimal(5, 2)
  icmsMvaAdj       Decimal? @db.Decimal(5, 2)
  icmsCredit       Boolean  @default(false)

  pisCstIn         String?
  pisCstOut        String?
  pisRate          Decimal? @db.Decimal(5, 2)
  cofinsCstIn      String?
  cofinsCstOut     String?
  cofinsRate       Decimal? @db.Decimal(5, 2)
  pisCofinsCredit  Boolean  @default(false) // Filial Lucro Real = true, Simples = false

  ipiCode          String? // Enquadramento
  ipiCst           String?
  ipiRate          Decimal? @db.Decimal(5, 2)
  ipiCredit        Boolean  @default(false)
  
  // Precificação por Loja (Custo e Venda podem variar por região)
  suggestedMargin  Decimal? @db.Decimal(5, 2)
  operationalCost  Decimal? @db.Decimal(5, 2)
  precoVenda       Decimal? @db.Decimal(10, 2)
  notes            String?

  @@unique([productId, storeId]) // Garante um config por produto por loja
}

// Tabela de Códigos de Barras Adicionais (Caixa, Fardo, etc)
model Barcode {
  id        String   @id @default(cuid())
  code      String
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([productId])
}

// Fornecedores vinculados ao produto
model ProductSupplier {
  id              String  @id @default(cuid())
  supplierCode    String? // Código no fornecedor
  supplierName    String
  unit            String  @default("UN")
  refCode         String? // Código de referência
  
  productId       String
  product         Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
}

// 4. Histórico de Compras (Sempre amarrado a uma loja específica)
model PurchaseHistory {
  id              String   @id @default(cuid())
  
  // Relacionamento Obrigatório com a Loja
  storeId         String
  store           Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  // Relacionamento com o Produto Global
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Dados da Nota
  supplierName    String
  date            DateTime
  totalQty        Decimal  @db.Decimal(12, 4)
  convertedQty    Decimal  @db.Decimal(12, 4)
  totalValue      Decimal  @db.Decimal(12, 2)
  unitPriceGross  Decimal  @db.Decimal(12, 4)
  unitCostNet     Decimal  @db.Decimal(12, 4) // Calculado usando a regra da Store + Produto
  
  createdAt       DateTime @default(now())

  @@index([storeId])
  @@index([productId])
}

// Modelo de Lote (Batch) - Agora vinculado obrigatoriamente a uma Loja
model Batch {
  id              String     @id @default(cuid())
  
  // Relacionamento Obrigatório com a Loja
  storeId         String
  store           Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  // Relacionamento com o Produto Global
  productId       String
  product         Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  expirationDate  DateTime
  quantityInitial Int        
  quantityCurrent Int        
  status          BatchStatus @default(SAFE)
  auditLogs       AuditLog[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([storeId])
  @@index([productId])
  @@index([expirationDate])
  @@index([status])
}

// Modelo de Log de Auditoria (Sem alterações relevantes)
model AuditLog {
  id         String         @id @default(cuid())
  userId     String
  user       User           @relation(fields: [userId], references: [id])
  batchId    String
  batch      Batch          @relation(fields: [batchId], references: [id], onDelete: Cascade)
  actionType AuditActionType
  quantity   Int?           // Quantidade afetada
  notes      String?
  timestamp  DateTime       @default(now())

  @@index([userId])
  @@index([batchId])
  @@index([timestamp])
}